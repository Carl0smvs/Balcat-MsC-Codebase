FROM python:3.10

ARG CI=False
ENV CI $CI

COPY Pipfile /
RUN apt update &&  \
    apt install ffmpeg libsm6 libxext6  -y && \
    pip install pipenv &&  \
    pipenv install  \
    && if [ "$CI" = "True" ]; then pipenv run pip install tensorflow[and-cuda]==2.15.1; fi

ARG TEST=False
ARG CUSTOM_MODEL=False
ARG GENERIC_MODEL=False
ARG CALIBER="9MM"
ARG CLASSES_CARTRIDGES_CSV_FILE="9mm_models_cases_count.csv"
ARG CLASSES_CASEIDS_JSON_FILE="9mm_case_ids_per_model.json"
ARG MODEL_TYPE=VGG_16
ARG MODEL_EXTENSION=h5
ARG SAMPLING_MODE
ARG WAVELET_FAMILY
ARG SMALL_DATASET=True
ARG SMALL_TRAIN_SIZE=100
ARG SMALL_VALIDATION_SIZE=50
ARG FINETUNE_MODELS=False

ARG DEFAULT_PLOT_DIRECTORY='media/plots/'
ARG DEFAULT_STATISTICS_DIRECTORY='media/statistics/'
ARG DEFAULT_MODELS_DIRECTORY='models/'
ARG DEFAULT_DATASET_DIRECTORY="dataset/"

ARG TRAIN_EPOCHS=5
ARG FINETUNE_EPOCHS=5
ARG BASE_LEARNING_RATE=0.01

ENV TEST $TEST
ENV CUSTOM_MODEL $CUSTOM_MODEL
ENV GENERIC_MODEL $GENERIC_MODEL
ENV CALIBER $CALIBER
ENV CLASSES_CARTRIDGES_CSV_FILE $CLASSES_CARTRIDGES_CSV_FILE
ENV CLASSES_CASEIDS_JSON_FILE $CLASSES_CASEIDS_JSON_FILE
ENV MODEL_TYPE $MODEL_TYPE
ENV MODEL_EXTENSION $MODEL_EXTENSION
ENV SAMPLING_MODE $SAMPLING_MODE
ENV WAVELET_FAMILY $WAVELET_FAMILY
ENV SMALL_DATASET $SMALL_DATASET
ENV SMALL_TRAIN_SIZE $SMALL_TRAIN_SIZE
ENV SMALL_VALIDATION_SIZE $SMALL_VALIDATION_SIZE
ENV FINETUNE_MODELS $FINETUNE_MODELS

ENV DEFAULT_PLOT_DIRECTORY $DEFAULT_PLOT_DIRECTORY
ENV DEFAULT_STATISTICS_DIRECTORY $DEFAULT_STATISTICS_DIRECTORY
ENV DEFAULT_MODELS_DIRECTORY $DEFAULT_MODELS_DIRECTORY
ENV DEFAULT_DATASET_DIRECTORY $DEFAULT_DATASET_DIRECTORY

ENV TRAIN_EPOCHS $TRAIN_EPOCHS
ENV FINETUNE_EPOCHS $FINETUNE_EPOCHS
ENV BASE_LEARNING_RATE $BASE_LEARNING_RATE

COPY train_model.py /
COPY data/${CLASSES_CARTRIDGES_CSV_FILE} /
COPY data/${CLASSES_CASEIDS_JSON_FILE} /
COPY utils/utils.py /utils/utils.py
COPY utils/dataset_load.py /utils/dataset_load.py
COPY utils/models.py /utils/models.py

CMD ["pipenv", "run", "python", "train_model.py"]