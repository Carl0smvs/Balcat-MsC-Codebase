FROM python:3.10

ARG CI=False
ENV CI $CI

COPY Pipfile /
RUN apt update &&  \
    apt install ffmpeg libsm6 libxext6  -y && \
    pip install pipenv &&  \
    pipenv install  \
    && if [ "$CI" = "True" ]; then pipenv run pip install tensorflow[and-cuda]==2.15.1; fi

ARG TEST=False
ARG CALIBER="9MM"
ARG MODEL_EXTENSION=h5
ARG SMALL_DATASET=False
ARG SMALL_TRAIN_SIZE=100
ARG SMALL_VALIDATION_SIZE=50
ARG PLOT_IMAGES_ENABLED
ARG SAMPLING_MODE
ARG TRAIN_MODELS=False
ARG EVAL_ENABLED=True

ARG DEFAULT_IMAGES_DIRECTORY='data/'
ARG DEFAULT_PLOT_DIRECTORY='media/plots/'
ARG DEFAULT_STATISTICS_DIRECTORY='media/statistics/'
ARG DEFAULT_MODELS_DIRECTORY='models/'
ARG DEFAULT_DATASET_DIRECTORY="dataset/"

ARG CLASSES_CARTRIDGES_CSV_FILE="9mm_models_cases_count.csv"
ARG CLASSES_CASEIDS_JSON_FILE="9mm_case_ids_per_model.json"

ARG BASE_LEARNING_RATE=0.01

ENV TEST $TEST
ENV CALIBER $CALIBER
ENV MODEL_EXTENSION $MODEL_EXTENSION
ENV SAMPLING_MODE $SAMPLING_MODE
ENV SMALL_DATASET $SMALL_DATASET
ENV SMALL_TRAIN_SIZE $SMALL_TRAIN_SIZE
ENV SMALL_VALIDATION_SIZE $SMALL_VALIDATION_SIZE
ENV PLOT_IMAGES_ENABLED $PLOT_IMAGES_ENABLED
ENV TRAIN_MODELS $TRAIN_MODELS
ENV EVAL_ENABLED $EVAL_ENABLED

ENV DEFAULT_IMAGES_DIRECTORY $DEFAULT_IMAGES_DIRECTORY
ENV DEFAULT_PLOT_DIRECTORY $DEFAULT_PLOT_DIRECTORY
ENV DEFAULT_STATISTICS_DIRECTORY $DEFAULT_STATISTICS_DIRECTORY
ENV DEFAULT_MODELS_DIRECTORY $DEFAULT_MODELS_DIRECTORY
ENV DEFAULT_DATASET_DIRECTORY $DEFAULT_DATASET_DIRECTORY

ENV CLASSES_CARTRIDGES_CSV_FILE $CLASSES_CARTRIDGES_CSV_FILE
ENV CLASSES_CASEIDS_JSON_FILE $CLASSES_CASEIDS_JSON_FILE

ENV BASE_LEARNING_RATE $BASE_LEARNING_RATE

COPY test_siamese_model.py /
COPY data/${CLASSES_CARTRIDGES_CSV_FILE} /
COPY data/${CLASSES_CASEIDS_JSON_FILE} /
COPY utils/utils.py /utils/utils.py
COPY utils/dataset_load.py /utils/dataset_load.py
COPY utils/models.py /utils/models.py

CMD ["pipenv", "run", "python", "test_siamese_model.py"]